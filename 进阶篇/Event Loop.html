<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Loop | Kernel Tahm</title>
    <meta name="description" content="前端 开发 学习 常空">
    <link rel="preload stylesheet" href="/vitepress-kether-tahm/assets/style.0f5fa127.css" as="style">
    
    <script type="module" src="/vitepress-kether-tahm/assets/app.2a2d808c.js"></script>
    <link rel="preload" href="/vitepress-kether-tahm/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/vitepress-kether-tahm/assets/chunks/framework.e9e877ca.js">
    <link rel="modulepreload" href="/vitepress-kether-tahm/assets/chunks/theme.0dbf6007.js">
    <link rel="modulepreload" href="/vitepress-kether-tahm/assets/进阶篇_Event Loop.md.7070e005.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/vitepress-kether-tahm/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/vitepress-kether-tahm/logo.png" alt data-v-8426fc1a><!--]--><!--[-->Kernel Tahm<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><span class="DocSearch-Button-Key">Meta</span><span class="DocSearch-Button-Key">K</span></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/vitepress-kether-tahm/%E8%BF%9B%E9%98%B6%E7%AF%87/Event%20Loop.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>🐌进阶篇</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-kether-tahm/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/requestAnimationFrame.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>💯性能优化</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 has-active" data-v-b00e2fdd data-v-e31bd47b><!----><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/vitepress-kether-tahm/%E8%BF%9B%E9%98%B6%E7%AF%87/Event%20Loop.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Event Loop</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _vitepress-kether-tahm_%E8%BF%9B%E9%98%B6%E7%AF%87_Event%20Loop" data-v-6b87e69f><div><h1 id="event-loop" tabindex="-1">Event Loop <a class="header-anchor" href="#event-loop" aria-label="Permalink to &quot;Event Loop&quot;">​</a></h1><p>ES 的运行环境都采用了<strong>单线程</strong>模型，这意味着任一时刻，ES 只能执行一个操作。单线程的好处是：不需要考虑并发和同步问题、避免竞态条件、节省内存。单线程的坏处在于：无法利用多核 CPU、不适合 CPU 密集型任务。</p><p>浏览器提供了 Web Workers 技术，使用 <code>Worker</code> 类创建独立线程。Node.js 提供了对应的 Worker Threads 技术，后者引用 <code>worker_threads</code> 包创建独立线程。这两种方案创建的独立线程，可以与主线程通信，从而利用多核 CPU，处理 CPU 密集型任务。</p><h2 id="浏览器的事件循环" tabindex="-1">浏览器的事件循环 <a class="header-anchor" href="#浏览器的事件循环" aria-label="Permalink to &quot;浏览器的事件循环&quot;">​</a></h2><p>在现代浏览器中，一个标签页通常是一个独立的进程，每个进程都可以包含多个线程。浏览器有一个主线程，负责处理子线程的协调和调度，这些子线程包括：</p><ul><li>渲染线程：负责页面的渲染和绘制，包括布局计算、绘制图形等任务</li><li>ES 引擎线程：负责解析和执行 ES 代码，ES 引擎线程运行会阻塞渲染线程的执行</li><li>事件线程：负责处理用户输入和其它事件的触发和处理</li><li>定时器线程：<code>setInterval</code> 与 <code>setTimeout</code> 所在的线程，用于计时并触发定时任务</li><li>存储线程：负责处理与存储相关的任务，如读取和写入本地存储</li><li>网络线程：负责处理网络请求和响应的发送和接收</li><li>工作线程（Web Workers）：用于执行耗时的操作，以避免阻塞主线程</li></ul><h3 id="调用栈" tabindex="-1">调用栈 <a class="header-anchor" href="#调用栈" aria-label="Permalink to &quot;调用栈&quot;">​</a></h3><p>调用栈是一个用于追踪函数调用的有限栈内存区域。当函数被调用时，会被推入调用栈，当函数执行完成后，会从调用栈中弹出。</p><p>函数执行过程中，如果触发了异步任务，会将被触发的异步任务交给<strong>特定的线程处理</strong>，函数继续执行完成后正常出栈。当异步操作完成需要执行回调函数时，<strong>特定的处理线程</strong>会将回调函数放入对应的任务队列。</p><h3 id="任务队列" tabindex="-1">任务队列 <a class="header-anchor" href="#任务队列" aria-label="Permalink to &quot;任务队列&quot;">​</a></h3><p>任务队列是一个遵循先进先出原则的队列，在浏览器中，任务队列由浏览器内核或 ES 引擎创建和管理，浏览器中包含两个主要的任务队列：<strong>宏任务队列（Macro Task Queue）<strong>和</strong>微任务队列（Micro Task Queue）</strong>，它们分别用于存放微任务和宏任务的回调函数，微任务队列执行的优先级高于宏任务队列。</p><h4 id="宏任务" tabindex="-1">宏任务 <a class="header-anchor" href="#宏任务" aria-label="Permalink to &quot;宏任务&quot;">​</a></h4><ul><li>定时器：<code>setTimeout()</code>、<code>setInterval()</code></li><li>UI 事件交互</li><li>网络请求</li><li><code>requestAnimationFrame()</code>：用于在浏览器的下一帧渲染之前执行回调函数</li><li><code>MessageChannel()</code>：用于跨线程异步通信</li></ul><h4 id="微任务" tabindex="-1">微任务 <a class="header-anchor" href="#微任务" aria-label="Permalink to &quot;微任务&quot;">​</a></h4><ul><li><code>Promise</code></li><li><code>await</code>：<code>await</code> 关键字后的 <code>Promise</code> 对象会被包装称微任务</li><li><code>MutationObserver()</code>：监听 DOM 变动的回调会被放入微任务队列</li></ul><h3 id="事件循环过程" tabindex="-1">事件循环过程 <a class="header-anchor" href="#事件循环过程" aria-label="Permalink to &quot;事件循环过程&quot;">​</a></h3><ol><li>主线程（指 ES 引擎线程）执行同步任务，入栈、出栈直到调用栈为空。执行过程中的异步任务交由特定线程处理，异步操作执行完成后，回调函数被放入对应的微任务队列或宏任务队列中</li><li>依次取出微任务队列中的回调函数直到清空</li><li>取出宏任务队列中的一个回调函数执行</li><li>依次取出微任务队列中的回调函数执行直到清空</li><li>重复 <code>3</code>、<code>4</code> 步骤，直至所有任务队列清空</li></ol><p>事件循环持续运行，不断检查微任务队列和宏任务队列。每执行一次宏任务回调函数，就需要清空所有微任务队列。</p><h2 id="node-js-的事件循环" tabindex="-1">Node.js 的事件循环 <a class="header-anchor" href="#node-js-的事件循环" aria-label="Permalink to &quot;Node.js 的事件循环&quot;">​</a></h2><p>Node.js 事件循环由 <code>libuv</code> 库实现，Node.js 执行过程中的异步任务交由 <code>libuv</code> 处理，异步操作执行完成后，回调函数会被放入对应的任务队列中。</p><p>当 Node.js 启动时会初始化事件循环，事件循环包含以下六个阶段，这些阶段会依次执行：</p><ol><li><code>timers</code>：执行到期的 <code>setTimeout()</code> 和 <code>setInterval()</code> 的回调</li><li><code>pending callbacks</code>：执行上一个循环的 <code>poll</code> 阶段还没来得及处理的回调</li><li><code>idle, prepare</code>：仅在 Node.js 内部使用，可忽略</li><li><code>poll</code>：执行网络请求、文件读写等 I/O 的回调</li><li><code>check</code>：执行 <code>setImmediate()</code> 的回调</li><li><code>close callbacks</code>：执行 <code>close</code> 事件回调，如 <code>socket.on(&#39;close&#39;, cb)</code> 的回调</li></ol><p><img src="/vitepress-kether-tahm/Node-eventloop.png" alt="Node-eventloop"></p><p>每个阶段都有一个对应的（宏）任务队列，每个阶段都需要清空对应的任务队列，执行完所有的回调函数，事件循环才会进入下一个阶段。Node.js 中还有另外还有两个优先级更高的队列：</p><ul><li><code>NextTick Queue</code>：存放 <code>procee.nextTick()</code> 回调，优先级最高，某个阶段产生的 <code>procee.nextTick()</code> 回调会插入前阶段的末尾执行，而不是下一个事件循环中</li><li><code>MicroTask Queue</code>：存放 <code>Promise</code> 的 <code>then()</code>、<code>catch()</code> 回调，行为类似 <code>procee.nextTick()</code>，优先级仅次于 <code>NextTick Queue</code></li></ul><p><img src="/vitepress-kether-tahm/Node-eventloop-order.png" alt="Node-eventloop-order"></p><h3 id="关于-poll-阶段" tabindex="-1">关于 <code>poll</code> 阶段 <a class="header-anchor" href="#关于-poll-阶段" aria-label="Permalink to &quot;关于 `poll` 阶段&quot;">​</a></h3><p>在 <code>poll</code> 阶段，I/O 的回调函数可能持续触发，因此这个过程可能会阻塞后续阶段的回调执行。</p><p>为确保定时器的执行不会误差太多，事件循环会使用定时器队列中最小的 <code>timeout</code>，如果在执行 <code>timeout</code> 时间后，还有 I/O 回调函数未执行，事件循环会立即结束当前 <code>poll</code> 阶段，并将剩余的回调函数放入 <code>pending callbacks</code> 队列。</p><p>由于回调函数本身是同步执行的，如果某次回调函数执行时间过长，那么定时器可能会有相当大的误差。</p><div class="language-JS vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">JS</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">https</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;https&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">https.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;https://httpbin.org/stream-bytes/10240?chunk_size=16&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">response</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    response.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;data&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">chunk</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;CHUNK&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    response.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;end&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;END&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  }).</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(err)</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">setTimeout</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SETTIMEOUT&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}, </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">https</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;https&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">https.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;https://httpbin.org/stream-bytes/10240?chunk_size=16&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">response</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    response.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;data&#39;</span><span style="color:#24292E;">, (</span><span style="color:#E36209;">chunk</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">      console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;CHUNK&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    response.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;end&#39;</span><span style="color:#24292E;">, () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">      console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;END&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  }).</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;error&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">err</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    console.</span><span style="color:#6F42C1;">error</span><span style="color:#24292E;">(err)</span></span>
<span class="line"><span style="color:#24292E;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">setTimeout</span><span style="color:#24292E;">(() </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;SETTIMEOUT&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}, </span><span style="color:#005CC5;">2000</span><span style="color:#24292E;">)</span></span></code></pre></div><p>适当调整 <code>setTimeout()</code> 延迟参数，可以得到下面的结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">SETTIMEOUT</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">CHUNK</span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">SETTIMEOUT</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">CHUNK</span></span>
<span class="line"><span style="color:#24292e;">...</span></span></code></pre></div><p>但是如果 <code>data</code> 事件的回调函数内有较复杂的费时操作，还是会影响到定时器的准确性。</p></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><!----><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7e05ebdb>Last updated: <time datetime="2023-08-09T10:10:11.000Z" data-v-7e05ebdb></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5a346dfe data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Released under the MIT License.</p><p class="copyright" data-v-e03eb2e1>Copyright © 2023-PRESENT Kernel Tahm</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"index.md\":\"415b5850\",\"性能优化_mutationobserver和resizeobserver.md\":\"a568b74a\",\"性能优化_requestidlecallback.md\":\"c95c03a6\",\"性能优化_requestanimationframe.md\":\"d5659aa2\",\"性能优化_css 走马灯实现.md\":\"41f328ad\",\"进阶篇_event loop.md\":\"7070e005\",\"性能优化_vue watch 新旧值一样，而 watch computed没问题.md\":\"5f598346\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Kernel Tahm\",\"description\":\"前端 开发 学习 常空\",\"base\":\"/vitepress-kether-tahm/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.png\",\"siteTitle\":\"Kernel Tahm\",\"markdown\":{\"lineNumbers\":true},\"lastUpdated\":true,\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2023-PRESENT Kernel Tahm\"},\"nav\":[{\"text\":\"🐌进阶篇\",\"link\":\"/进阶篇/Event Loop\"},{\"text\":\"💯性能优化\",\"link\":\"/性能优化/requestAnimationFrame\"}],\"sidebar\":{\"/进阶篇/\":[{\"items\":[{\"text\":\"Event Loop\",\"link\":\"/进阶篇/Event Loop\"}]}],\"/性能优化/\":[{\"items\":[{\"text\":\"requestAnimationFrame\",\"link\":\"/性能优化/requestAnimationFrame\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>